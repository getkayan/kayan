package identity

import (
	"database/sql/driver"
	"errors"
	"fmt"
	"time"

	"gorm.io/gorm"
)

// Default types for high-level use cases
type DefaultIdentity = Identity
type DefaultCredential = Credential
type DefaultSession = Session

// JSON is a custom type for handling JSON data in GORM.
type JSON []byte

func (j JSON) Value() (driver.Value, error) {
	if len(j) == 0 {
		return nil, nil
	}
	return string(j), nil
}

func (j *JSON) Scan(value interface{}) error {
	if value == nil {
		*j = nil
		return nil
	}
	switch v := value.(type) {
	case []byte:
		*j = append((*j)[0:0], v...)
	case string:
		*j = []byte(v)
	default:
		return errors.New("invalid type for JSON")
	}
	return nil
}

// Identity represents a user identity.
type Identity struct {
	ID        string         `gorm:"primaryKey" json:"id"`
	Traits    JSON           `gorm:"type:json" json:"traits"`
	CreatedAt time.Time      `json:"created_at"`
	UpdatedAt time.Time      `json:"updated_at"`
	DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`

	Credentials []Credential `gorm:"foreignKey:IdentityID" json:"-"`
}

func (i *Identity) GetID() any { return i.ID }
func (i *Identity) SetID(id any) {
	if s, ok := id.(string); ok {
		i.ID = s
	} else {
		i.ID = fmt.Sprintf("%v", id)
	}
}
func (i *Identity) GetTraits() JSON               { return i.Traits }
func (i *Identity) SetTraits(t JSON)              { i.Traits = t }
func (i *Identity) GetCredentials() []Credential  { return i.Credentials }
func (i *Identity) SetCredentials(c []Credential) { i.Credentials = c }

func (Identity) TableName() string { return "identities" }

// Credential represents an authentication credential.
type Credential struct {
	ID         string    `gorm:"primaryKey" json:"id"`
	IdentityID string    `gorm:"index" json:"identity_id"`
	Type       string    `gorm:"index" json:"type"`
	Identifier string    `gorm:"index" json:"identifier"`
	Secret     string    `json:"-"`
	Config     JSON      `gorm:"type:json" json:"config"`
	CreatedAt  time.Time `json:"created_at"`
	UpdatedAt  time.Time `json:"updated_at"`
}

func (Credential) TableName() string { return "credentials" }

// Session represents an authenticated session.
type Session struct {
	ID               string    `gorm:"primaryKey" json:"id"`
	IdentityID       string    `gorm:"index" json:"identity_id"`
	RefreshToken     string    `gorm:"index" json:"refresh_token,omitempty"`
	ExpiresAt        time.Time `json:"expires_at"`
	RefreshExpiresAt time.Time `json:"refresh_expires_at,omitempty"`
	IssuedAt         time.Time `json:"issued_at"`
	Active           bool      `json:"active"`
}

func (Session) TableName() string { return "sessions" }
